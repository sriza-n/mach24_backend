<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Visualization</title>
    <link rel="stylesheet" href="static\css\style.css" />
    <!-- Use CDN for ECharts -->
    <script src="static/lib/echarts.min.js"></script>
    <!-- <script type="text/javascript" src="static\js\visualize.js"></script> -->
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #pressureChart {
            width: 100%;
            height: 100%;
        }

        #controlBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-evenly">
            <div class="col-4">
                <div id="pressureChart"></div>
            </div>
            <div class="col-4">
                <div id="pressureChart"></div>
            </div>
        </div>
        <div class="row justify-content-evenly">
            <div class="col-4">
                <div id="pressureChart"></div>
            </div>
            <div class="col-4">
                <div id="pressureChart"></div>
            </div>
        </div>
    </div>
    
    
    <button id="controlBtn">Pause</button>
</body>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const chartDom = document.getElementById('pressureChart');
        const myChart = echarts.init(chartDom);

        const option = {
            animationDuration: 1000,
            // title: {
            //     text: 'Pressure Data Visualization'
            // },
            legend: {
                data: ['Pressure 1', 'Pressure 2']
            },
            tooltip: {
                order: 'valueDesc',
                trigger: 'axis'
            },
            xAxis: {
                type: 'category',
                name: 'Time (s)',
                nameLocation: 'middle',
                data: [] // Time labels
            },
            yAxis: {
                name: 'Pressure'
            },
            grid: {
                right: 140
            },
            dataZoom: [
                // {
                //     type: 'slider',
                //     start: 0,
                //     end: 100
                // },
                {
                    type: 'inside',
                    start: 0,
                    end: 100
                }
            ],
            series: [
                {
                    name: 'Pressure 1',
                    type: 'line',
                    showSymbol: true,
                    smooth: true,
                    emphasis: {
                        focus: 'series'
                    },
                    data: [] // Pressure 1 data
                },
                {
                    name: 'Pressure 2',
                    type: 'line',
                    showSymbol: true,
                    smooth: true,
                    emphasis: {
                        focus: 'series'
                    },
                    data: [] // Pressure 2 data
                }
            ]
        };

        myChart.setOption(option);

        // Plot initial data
        const initialData = JSON.parse('{{ data | tojson | safe }}');
        const timeSet = new Set();
        initialData.forEach(record => {
            const timeString = record.time;
            const pressure1 = record.pressure1;
            const pressure2 = record.pressure2;

            option.xAxis.data.unshift(timeString);
            option.series[0].data.unshift(pressure1);
            option.series[1].data.unshift(pressure2);
            timeSet.add(timeString);
        });

        myChart.setOption(option);

        let fetchDataInterval;
        const fetchData = () => {
            fetch('/latest_data')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const latestData = data[0];
                        const timeString = latestData.time;
                        const pressure1 = latestData.pressure1;
                        const pressure2 = latestData.pressure2;
                        option.xAxis.data.push(timeString);
                        option.series[0].data.push(pressure1);
                        option.series[1].data.push(pressure2);

                        myChart.setOption(option);
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        };

        // Fetch data every 1 second
        fetchDataInterval = setInterval(fetchData, 1000);

        // Resize chart on window resize
        window.addEventListener('resize', () => {
            myChart.resize();
        });

        // Control button to pause/resume fetching data
        const controlBtn = document.getElementById('controlBtn');
        let isPaused = false;
        controlBtn.addEventListener('click', () => {
            if (isPaused) {
                fetchDataInterval = setInterval(fetchData, 1000);
                controlBtn.textContent = 'Pause';
            } else {
                clearInterval(fetchDataInterval);
                controlBtn.textContent = 'Resume';
            }
            isPaused = !isPaused;
        });
    });
</script>

</html>